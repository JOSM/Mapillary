image: registry.gitlab.com/josm/docker-library/openjdk-8-josmplugin-openjfx:latest

variables:
  GIT_SUBMODULE_STRATEGY: recursive

include:
  - template: Dependency-Scanning.gitlab-ci.yml
  - template: License-Scanning.gitlab-ci.yml

stages:
  - build
  - test
  - deploy
  - release

###############
# Build stage #
###############

assemble:
  stage: build
  script:
    - ./gradlew assemble --stacktrace
  artifacts:
    paths:
      - build/

java 11 assemble:
  stage: build
  image: registry.gitlab.com/josm/docker-library/openjdk-11-josmplugin:latest
  script:
    - ./gradlew assemble --stacktrace
  artifacts:
    paths:
      - build/

java 12 assemble:
  stage: build
  image: registry.gitlab.com/josm/docker-library/openjdk-12-josmplugin:latest
  script:
    - ./gradlew assemble --stacktrace
  artifacts:
    paths:
      - build/
  allow_failure: true

java 13 assemble:
  stage: build
  image: registry.gitlab.com/josm/docker-library/openjdk-13-josmplugin:latest
  script:
    - ./gradlew assemble --stacktrace
  artifacts:
    paths:
      - build/
  allow_failure: true

java 14 assemble:
  stage: build
  image: registry.gitlab.com/josm/docker-library/openjdk-14-josmplugin:latest
  script:
    - ./gradlew assemble --stacktrace
  artifacts:
    paths:
      - build/
  allow_failure: true

java 15 assemble:
  stage: build
  image: registry.gitlab.com/josm/docker-library/openjdk-15-josmplugin:latest
  script:
    - ./gradlew assemble --stacktrace
  artifacts:
    paths:
      - build/
  allow_failure: true


##############
# Test stage #
##############

build:
  stage: test
  script:
    - ./gradlew build --stacktrace
  artifacts:
    paths:
    - build
  needs: ["assemble"]

translate:
  stage: test
  script:
    - ./gradlew generatePot --stacktrace
  artifacts:
    paths:
    - build
  needs: ["assemble"]

min JOSM compile:
  stage: test
  script:
    - ./gradlew compileJava_minJosm --stacktrace
  needs: ["assemble"]

latest JOSM compile:
  stage: test
  script:
    - ./gradlew compileJava_latestJosm --stacktrace
  needs: ["assemble"]

java 11 build:
  stage: test
  image: registry.gitlab.com/josm/docker-library/openjdk-11-josmplugin:latest
  script:
    - ./gradlew build --stacktrace
  needs: ["java 11 assemble"]

java 12 build:
  stage: test
  image: registry.gitlab.com/josm/docker-library/openjdk-12-josmplugin:latest
  script:
    - ./gradlew build --stacktrace
  needs: ["java 12 assemble"]
  allow_failure: true

java 13 build:
  stage: test
  image: registry.gitlab.com/josm/docker-library/openjdk-13-josmplugin:latest
  script:
    - ./gradlew build --stacktrace
  needs: ["java 13 assemble"]
  allow_failure: true

java 14 build:
  stage: test
  image: registry.gitlab.com/josm/docker-library/openjdk-13-josmplugin:latest
  script:
    - ./gradlew build --stacktrace
  needs: ["java 14 assemble"]
  allow_failure: true

java 15 build:
  stage: test
  image: registry.gitlab.com/josm/docker-library/openjdk-13-josmplugin:latest
  script:
    - ./gradlew build --stacktrace
  needs: ["java 15 assemble"]
  allow_failure: true

################
# Deploy stage #
################

transifex.com:
  image: registry.gitlab.com/josm/docker-library/python-transifex:latest
  stage: deploy
  environment:
    name: transifex.com
    url: https://www.transifex.com/josm/josm/josm-plugin_Mapillary/
  script:
    - TX_TOKEN="$TRANSIFEX_TOKEN" tx push -s --no-interactive
  needs: ["translate"]
  only:
    refs:
      - master
    variables:
      - $TRANSIFEX_TOKEN

codecov.io:
  image: alpine:3.10
  stage: deploy
  environment:
    name: codecov.io
    url: https://codecov.io/gh/JOSM/Mapillary
  before_script:
    - apk add --update curl bash
  script:
    - curl -s https://codecov.io/bash | bash
    - curl -s https://codecov.io/bash | bash /dev/stdin -c -F model_and_api
  needs: ["build"]
  only:
    refs:
      - master
    variables:
      - $CODECOV_TOKEN

sonarcloud.io:
  image: registry.gitlab.com/josm/docker-library/openjdk-11-josmplugin:latest
  stage: deploy
  environment:
    name: sonarcloud.io
    url: https://sonarcloud.io/dashboard?id=org.openstreetmap.josm.plugins%3AMapillary
  script:
    - ./gradlew -Dsonar.login=$SONAR_TOKEN sonarqube
  needs: ["build"]
  only:
    refs:
      - master
    variables:
      - $SONAR_TOKEN

GitLab Maven repo:
  stage: deploy
  environment:
    name: GitLab.com / Maven packages
    url: https://gitlab.com/JOSM/plugin/Mapillary/-/packages
  script:
    - ./gradlew publishAllPublicationsToGitlabRepository
  needs: ["build", "min JOSM compile", "latest JOSM compile"]
  only:
    - tags@JOSM/plugin/Mapillary

release:
  stage: deploy
  environment:
    name: GitLab.com / pages branch
    url: https://gitlab.com/JOSM/plugin/Mapillary/tree/pages/dist
  script:
  - |
    base64 --decode "$SSH_PRIVATE_DEPLOY_KEY" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    git clone --depth 1 --branch pages git@gitlab.com:JOSM/plugin/Mapillary.git pages
  - |
    version=`git describe --always --dirty`
    longVersion=`git describe --always --long --dirty`
    commitMessage="Release version $longVersion"
  - |
    mkdir -pv "pages/dist/$version"
    cp -v build/dist/* build/tmp/jar/MANIFEST.MF "pages/dist/$version"
    rm -fv "pages/dist/latest"
    ln -s "./$version" "pages/dist/latest"
  - |
    cd pages/
    git config user.name "GitLab CI for JOSM/plugin/Mapillary"
    git config user.email "incoming+josm-plugin-mapillary-8564565-issue-@incoming.gitlab.com"
    git stage .
    git commit -a -m "$commitMessage"
    git push origin pages
  needs: ["build", "min JOSM compile", "latest JOSM compile"]
  only:
    - tags@JOSM/plugin/Mapillary


#################
# Release stage #
#################

release to Gitlab.com:
  stage: release
  environment:
    name: GitLab.com / Releases
    url: https://gitlab.com/JOSM/plugin/Mapillary/-/releases
  script:
    - ./gradlew releaseToGitlab
  needs: ["GitLab Maven repo"]
  only:
    - tags@JOSM/plugin/Mapillary
